<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>code - Das Keyboard Shredder</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




    <meta name="author" content="Neville Li" />
    <meta name="keywords" content="code" />

    <!-- Open Graph tags -->
        <meta property="og:site_name" content="Das Keyboard Shredder" />
        <meta property="og:type" content="website"/>
        <meta property="og:title" content="Das Keyboard Shredder"/>
        <meta property="og:url" content="https://www.lyh.me"/>
        <meta property="og:description" content="Das Keyboard Shredder"/>



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://www.lyh.me/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://www.lyh.me/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://www.lyh.me/theme/css/pygments/monokai.css" rel="stylesheet">
        <link href="https://www.lyh.me/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://www.lyh.me/theme/css/style.css" type="text/css"/>

        <link href="https://www.lyh.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Das Keyboard Shredder ATOM Feed"/>

        <link href="https://www.lyh.me/feeds/code.atom.xml" type="application/atom+xml" rel="alternate"
              title="Das Keyboard Shredder code ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://www.lyh.me/" class="navbar-brand">
Das Keyboard Shredder            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://www.lyh.me/pages/about-me.html">
                             About&nbsp;Me
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
            <article>
                <h2><a href="https://www.lyh.me/featran.html">Featran</a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-12-11T13:58:00-05:00"> Mon 11 December 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://www.lyh.me/category/code.html">code</a>


<span class="label label-default">Tags</span>
	<a href="https://www.lyh.me/tag/scala.html">scala</a>
        /
	<a href="https://www.lyh.me/tag/fp.html">fp</a>
        /
	<a href="https://www.lyh.me/tag/data.html">data</a>
        /
	<a href="https://www.lyh.me/tag/ml.html">ml</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p>Featran is a Scala feature transformation library for data science and machine learning. We recently open sourced it and I gave talks at <a href="http://scale.bythebay.io/">Scale By the Bay</a> and <a href="http://www.criteo.com/events/nabdconf-palo-alto/">NABDConf</a>. Here are the <a href="/slides/featran.html">slides</a>.</p>
<iframe src="/slides/featran.html" width="800" height="450"></iframe>
                    <a class="btn btn-default btn-xs" href="https://www.lyh.me/featran.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="https://www.lyh.me/automatic-type-class-derivation-with-shapeless.html">Automatic type-class derivation with&nbsp;Shapeless</a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-08-21T09:30:00-04:00"> Mon 21 August 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://www.lyh.me/category/code.html">code</a>


<span class="label label-default">Tags</span>
	<a href="https://www.lyh.me/tag/scala.html">scala</a>
        /
	<a href="https://www.lyh.me/tag/fp.html">fp</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p>We had a knowledge sharing session at work recently on <a href="https://github.com/milessabin/shapeless/">Shapeless</a> for automatic type class derivation. Here is a little write-up for the&nbsp;topic.</p>
<h2>Scala&nbsp;List</h2>
<p>First let&#8217;s review how <code>List</code> works in Scala. A <code>List</code> is a linked list with <code>head</code> and <code>tail</code>, plus <code>Nil</code> for empty list. It can be represented with the following abstract data&nbsp;type:</p>
<div class="highlight"><pre><span></span><code><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">List</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="o">::[</span><span class="kt">B</span> <span class="k">&gt;:</span> <span class="kt">A</span><span class="o">](</span><span class="n">head</span><span class="k">:</span> <span class="kt">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="k">this</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Nil</span> <span class="k">extends</span> <span class="nc">List</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]</span> <span class="c1">// Nothing is a sub-type of every other type</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Cons</span><span class="o">[</span><span class="kt">+A</span><span class="o">](</span><span class="n">head</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">tail</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</code></pre></div>


<p>Notice that <code>::</code>, the list concatenation operation, is just a method on trait <code>List[+A]</code>. Since Scala operators that end with <code>:</code> are right-associative, we can conveniently create lists by chaining multiple <code>::</code>s. Therefore the following expressions are&nbsp;equivalent:</p>
<div class="highlight"><pre><span></span><code><span class="mi">1</span> <span class="o">::</span> <span class="mi">2</span> <span class="o">::</span> <span class="nc">Nil</span>
<span class="mi">1</span> <span class="o">::</span> <span class="o">(</span><span class="mi">2</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
<span class="nc">Nil</span><span class="o">.::(</span><span class="mi">2</span><span class="o">).::(</span><span class="mi">1</span><span class="o">)</span>
<span class="nc">Cons</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Cons</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">Nil</span><span class="o">))</span>
</code></pre></div>


<p>It&#8217;s important to point out here that Scala <code>List</code> is homogeneous, i.e. it has a single type parameter <code>A</code> and thus can only store elements of <code>A</code> and its sub-types. On the other hand, it can have varying numbers of elements at&nbsp;runtime.</p>
<h2>Shapeless&nbsp;HList</h2>
<p>Since <code>List …</code></p>
                    <a class="btn btn-default btn-xs" href="https://www.lyh.me/automatic-type-class-derivation-with-shapeless.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="https://www.lyh.me/lambda-serialization.html">Lambda&nbsp;serialization</a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-08-01T13:51:00-04:00"> Tue 01 August 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://www.lyh.me/category/code.html">code</a>


<span class="label label-default">Tags</span>
	<a href="https://www.lyh.me/tag/scala.html">scala</a>
        /
	<a href="https://www.lyh.me/tag/scio.html">scio</a>
        /
	<a href="https://www.lyh.me/tag/data.html">data</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p>Lambda serialization is one of the more confusion issues in distributed data processing in Scala. No matter which framework you choose, whether it&#8217;s Scalding, Spark, Flink or Scio, sooner or later you&#8217;ll be hit by the dreaded <code>NotSerializableException</code>. In this post we&#8217;ll take a closer look at the common causes and solutions to this&nbsp;problem.</p>
<h2>Setup</h2>
<p>To demonstrate the problem, first we need a minimal setup that minics the behavior of a distributed data processing system. We start with a utility method that roundtrips an object throguh Java serialization. Anonymous functions, or lambdas, in such systems are serialized so that they can be distributed to workers for parallel&nbsp;processing.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span> <span class="nn">java.io.</span><span class="o">{</span><span class="nc">ByteArrayInputStream</span><span class="o">,</span> <span class="nc">ByteArrayOutputStream</span><span class="o">,</span> <span class="nc">ObjectInputStream</span><span class="o">,</span> <span class="nc">ObjectOutputStream</span><span class="o">}</span>

<span class="k">object</span> <span class="nc">SerDeUtil</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">serDe</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">obj</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">buffer</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">()</span>
    <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>

    <span class="k">val</span> <span class="n">in</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">toByteArray</span><span class="o">))</span>
    <span class="n">in</span><span class="o">.</span><span class="n">readObject</span><span class="o">().</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>Next we create a bare minimal <code>Collection[T]</code> type that mimics an abstract distributed data set, akin to <code>TypedPipe</code>, <code>RDD</code>, or <code>SCollection</code> in Scalding, Spark or Scio respectively. Our implementation is backed by a local in-memory <code>Seq[T]</code> but does pass the function <code>f</code> through serialization like …</p>
                    <a class="btn btn-default btn-xs" href="https://www.lyh.me/lambda-serialization.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="https://www.lyh.me/lawfulness-of-aggregatebykey.html">Lawfulness of&nbsp;aggregateByKey</a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-07-19T11:23:00-04:00"> Wed 19 July 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://www.lyh.me/category/code.html">code</a>


<span class="label label-default">Tags</span>
	<a href="https://www.lyh.me/tag/scala.html">scala</a>
        /
	<a href="https://www.lyh.me/tag/scio.html">scio</a>
        /
	<a href="https://www.lyh.me/tag/data.html">data</a>
        /
	<a href="https://www.lyh.me/tag/fp.html">fp</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p>I spent a couple hours yesterday debugging what I thought was a Protobuf serialization issue, which turns out to be an unlawful Monoid-like use of <code>aggregateByKey</code> in <a href="https://github.com/spotify/scio">Scio</a>.</p>
<h2>The&nbsp;Problem</h2>
<p>Both Scio and Spark have <code>aggregate</code> and <code>aggregateByKey</code> transformations that look like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// on SCollection[V]</span>
<span class="k">def</span> <span class="n">aggregate</span><span class="o">[</span><span class="kt">U</span><span class="o">](</span><span class="n">zeroValue</span><span class="k">:</span> <span class="kt">U</span><span class="o">)(</span><span class="n">seqOp</span><span class="k">:</span> <span class="o">(</span><span class="kt">U</span><span class="o">,</span> <span class="kt">V</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">U</span><span class="o">,</span> <span class="n">combOp</span><span class="k">:</span> <span class="o">(</span><span class="kt">U</span><span class="o">,</span> <span class="kt">U</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">U</span><span class="o">)</span><span class="k">:</span> <span class="kt">SCollection</span><span class="o">[</span><span class="kt">U</span><span class="o">]</span>

<span class="c1">// on SCollection[(K, V)]</span>
<span class="k">def</span> <span class="n">aggregateByKey</span><span class="o">[</span><span class="kt">U</span><span class="o">](</span><span class="n">zeroValue</span><span class="k">:</span> <span class="kt">U</span><span class="o">)(</span><span class="n">seqOp</span><span class="k">:</span> <span class="o">(</span><span class="kt">U</span><span class="o">,</span> <span class="kt">V</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">U</span><span class="o">,</span> <span class="n">combOp</span><span class="k">:</span> <span class="o">(</span><span class="kt">U</span><span class="o">,</span> <span class="kt">U</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">U</span><span class="o">)</span><span class="k">:</span> <span class="kt">SCollection</span><span class="o">[(</span><span class="kt">K</span><span class="p">,</span> <span class="kt">U</span><span class="o">)]</span>
</code></pre></div>


<p>And we have some business logic that looks like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Count</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">count</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">val</span> <span class="n">z</span> <span class="k">=</span> <span class="nc">Count</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// zeroValue</span>
<span class="k">def</span> <span class="n">seqOp</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Count</span><span class="o">,</span> <span class="n">v</span><span class="k">:</span> <span class="kt">Count</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Count</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">count</span><span class="o">)</span>
<span class="k">def</span> <span class="n">combOp</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Count</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Count</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Count</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="n">y</span><span class="o">.</span><span class="n">count</span><span class="o">)</span>

<span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="nc">Count</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="nc">Count</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="mi">100</span><span class="o">),</span> <span class="nc">Count</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">,</span> <span class="mi">5</span><span class="o">),</span> <span class="nc">Count</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">,</span> <span class="mi">50</span><span class="o">)))</span>
  <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
  <span class="o">.</span><span class="n">aggregateByKey</span><span class="o">(</span><span class="n">z</span><span class="o">)(</span><span class="n">seqOp</span><span class="o">,</span> <span class="n">combOp</span><span class="o">)</span>
</code></pre></div>


<p>This code however, only works correctly locally with <code>DirectRunner</code> and always produces results with <code>id == ""</code> when running on Dataflow service with the <code>DataflowRunner</code>. Can you spot the&nbsp;bug?</p>
<h2>Monoid&nbsp;laws</h2>
<p>You might notice that <code>zeroValue</code> and <code>combOp</code> together resemble a <a href="https://en.wikipedia.org/wiki/Monoid">Monoid</a>, which should satisfy the identity&nbsp;law:</p>
<div class="highlight"><pre><span></span><code><span class="n">combOp</span><span class="o">(</span><span class="n">zeroValue …</span></code></pre></div>
                    <a class="btn btn-default btn-xs" href="https://www.lyh.me/lawfulness-of-aggregatebykey.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="https://www.lyh.me/canbuildfrom.html">CanBuildFrom</a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-05-18T09:46:00-04:00"> Thu 18 May 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://www.lyh.me/category/code.html">code</a>


<span class="label label-default">Tags</span>
	<a href="https://www.lyh.me/tag/scala.html">scala</a>
        /
	<a href="https://www.lyh.me/tag/fp.html">fp</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p>We recently had an internal knowledge sharing on higher-kinded types and <code>CanBuildFrom</code> type classes in Scala. Here&#8217;s a short&nbsp;summary.</p>
<h2>Basics</h2>
<p>Let&#8217;s start by implementing <code>map</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="n">map</span><span class="o">(</span><span class="n">xs</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="n">f</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="nc">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
<span class="n">map</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">),</span> <span class="k">_</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">)</span>
</code></pre></div>


<p>This implementation is not very good since it only works with <code>Seq[Int]</code> and <code>Int =&gt; Double</code>. It&#8217;s easy to parameterize <code>Int</code> and <code>Double</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">A</span><span class="p">,</span> <span class="kt">B</span><span class="o">](</span><span class="n">xs</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
</code></pre></div>


<p>However <code>map(Seq(1, 2, 3), _ + 0.1)</code> now fails to compile with a message <code>missing parameter type for expanded function ((x$1) =&gt; x$1.$plus(10))</code></p>
<p>This is because inference of <code>A</code> in <code>f: A =&gt; B</code> depends on the type of <code>xs: Seq[A]</code>, and limitation of Scala type inference. A common workaround is to curry&nbsp;arguments.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">A</span><span class="p">,</span> <span class="kt">B</span><span class="o">](</span><span class="n">xs</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">A</span><span class="o">])(</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
<span class="n">map</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">))(</span><span class="k">_</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">)</span>
</code></pre></div>


<p>Similar pattern is commonly seen in Scala, like <code>foldLeft(z: B)(op: (B, A) =&gt; B)</code>. Another benefit is we can now write <code>f</code> in a multi-line <code>{}</code> block more&nbsp;elegantly.</p>
<div class="highlight"><pre><span></span><code><span class="n">map …</span></code></pre></div>
                    <a class="btn btn-default btn-xs" href="https://www.lyh.me/canbuildfrom.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="https://www.lyh.me/decompiling-scala-code.html">Decompiling Scala&nbsp;code</a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-05-06T17:14:00-04:00"> Sat 06 May 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://www.lyh.me/category/code.html">code</a>


<span class="label label-default">Tags</span>
	<a href="https://www.lyh.me/tag/scala.html">scala</a>
        /
	<a href="https://www.lyh.me/tag/fp.html">fp</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p>I was bored today and decided to decompile some Scala code for fun and profit. I&#8217;m using Scala 2.12.2 and Java&nbsp;1.8.0_121.</p>
<h2>Scala&nbsp;object</h2>
<div class="highlight"><pre><span></span><code><span class="k">package</span> <span class="nn">javap</span>

<span class="k">object</span> <span class="nc">Test01</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="nc">Unit</span>
<span class="o">}</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">javap</span><span class="p">.</span><span class="na">Test01$</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">javap</span><span class="p">.</span><span class="na">Test01$</span> <span class="n">MODULE$</span><span class="p">;</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="p">{};</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">String</span><span class="o">[]</span><span class="p">);</span>
  <span class="kd">private</span> <span class="n">javap</span><span class="p">.</span><span class="na">Test01$</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">javap</span><span class="p">.</span><span class="na">Test01</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">String</span><span class="o">[]</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>


<p>As we can see a Scala object is compiled to 2 Java classes, <code>Test01</code> with static methods for Java compatibility and a <code>Test01$</code> with a static instance of itself as <code>MODULE$</code>, so that <code>Test01</code> can be used as an instance value in&nbsp;Scala.</p>
<h2>Class&nbsp;constructors</h2>
<div class="highlight"><pre><span></span><code><span class="k">package</span> <span class="nn">javap</span>

<span class="k">class</span> <span class="nc">Test02</span><span class="o">(</span><span class="k">val</span> <span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="k">val</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">z</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="k">this</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="k">this</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">javap</span><span class="p">.</span><span class="na">Test02</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">x</span><span class="p">();</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">y</span><span class="p">();</span>
  <span class="kd">public</span> <span class="n">javap</span><span class="p">.</span><span class="na">Test02</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
  <span class="kd">public</span> <span class="n">javap</span><span class="p">.</span><span class="na">Test02</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>


<p>Looks like the default constructor <code>(val x: Int, val y: Int, z: Int)</code> and the overloaded one <code>(x: Int, y: Int)</code> each generated a Java constructor. However only <code>x</code> and <code>y …</code></p>
                    <a class="btn btn-default btn-xs" href="https://www.lyh.me/decompiling-scala-code.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="https://www.lyh.me/implicits.html">Implicits</a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-04-21T08:48:00-04:00"> Fri 21 April 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://www.lyh.me/category/code.html">code</a>


<span class="label label-default">Tags</span>
	<a href="https://www.lyh.me/tag/scala.html">scala</a>
        /
	<a href="https://www.lyh.me/tag/fp.html">fp</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p>In this post we&#8217;re going to take a closer look at Scala implicits and various use&nbsp;cases.</p>
<h2>Basics</h2>
<p>Let&#8217;s first look at the basics. There&#8217;re 3 main basic uses of implicits, as an argument, as a conversion method, and enhancing an existing class, a.k.a. the &#8220;Pimp My Library&#8221;&nbsp;pattern.</p>
<h3>Implicit&nbsp;arguments</h3>
<p>Suppose we have a basic function like&nbsp;this.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="n">plus</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">plus</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span> <span class="c1">// =&gt; 11</span>
</code></pre></div>


<p>We can add a second argument and make it a curried&nbsp;function.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="n">plus</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">y</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="n">plus</span><span class="o">(</span><span class="mi">10</span><span class="o">)(</span><span class="mi">1</span><span class="o">)</span> <span class="c1">// =&gt; 11</span>
</code></pre></div>


<p>We can then make the second argument implicit and supply it via an <code>implicit val</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="n">plus</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">one</span> <span class="k">=</span> <span class="mi">1</span>
<span class="n">plus</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span> <span class="c1">// =&gt; 11</span>
</code></pre></div>


<p>Since <code>plus</code> needs an implicit argument of type <code>Int</code> and there happens to be one in the scope, <code>one</code> is applied automatically. However it won&#8217;t work if there are multiple <code>implicit val</code>s.</p>
<div class="highlight"><pre><span></span><code><span class="k">implicit</span> <span class="k">val</span> <span class="n">one</span> <span class="k">=</span> <span class="mi">1</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">two</span> <span class="k">=</span> <span class="mi">2</span>
<span class="n">plus</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span> <span class="c1">// =&gt; ambiguous implicit values</span>
</code></pre></div>


<p>This example isn&#8217;t very interesting and one can usually use argument with a default value instead. However implicit arguments are handy for decoupling behavior …</p>
                    <a class="btn btn-default btn-xs" href="https://www.lyh.me/implicits.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="https://www.lyh.me/scio-at-philly-ete.html">Scio at Philly <span class="caps">ETE</span></a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-04-20T11:12:00-04:00"> Thu 20 April 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://www.lyh.me/category/code.html">code</a>


<span class="label label-default">Tags</span>
	<a href="https://www.lyh.me/tag/data.html">data</a>
        /
	<a href="https://www.lyh.me/tag/scala.html">scala</a>
        /
	<a href="https://www.lyh.me/tag/scio.html">scio</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p>It&#8217;s been another 6 months since my talk about <a href="https://github.com/spotify/scio">Scio</a> at <a href="http://scala.bythebay.io">Scala by the Bay</a>. We&#8217;ve seen huge adoption and improvements since then. The number of production Scio pipelines has grown from ~70 to 400+ within <a href="https://www.spotify.com/">Spotify</a>. A lot of other companies are using and contributing to it as well. In the most recent edition of the Spotify data university, an internal week long big data training camp for non-data engineers, we revamped the curriculum to cover Scio, BigQuery and other <a href="https://cloud.google.com/solutions/big-data/">Google Cloud Big Data</a> products instead of Hadoop, Scalding and&nbsp;Hive.</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Spotify data university round 3 <span class="amp">&amp;</span> 1st time covering Scio, <a href="https://twitter.com/ApacheBeam">@ApacheBeam</a> <span class="amp">&amp;</span> <a href="https://twitter.com/GCPBigData">@GCPBigData</a> 👋 Hadoop, <span class="caps">HDFS</span>, M/R, <span class="caps">YARN</span> 🍾 batch + streaming <a href="https://t.co/1gWIEbN0mW">pic.twitter.com/1gWIEbN0mW</a></p>&mdash; Neville Li (@sinisa_lyh) <a href="https://twitter.com/sinisa_lyh/status/846549633367265281">March 28, 2017</a></blockquote>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>And here&#8217;s a list of some notable improvements in&nbsp;Scio.</p>
<ul>
<li>Master branch is now based on <a href="https://beam.apache.org/">Apache&nbsp;Beam</a></li>
<li>Graduate type safe BigQuery <span class="caps">API</span> form experimental to&nbsp;stable</li>
<li><a href="https://github.com/spotify/sparkey-java">Sparkey</a> side input&nbsp;support</li>
<li><a href="https://www.tensorflow.org/">TensorFlow</a> TFRecord file <span class="caps">IO</span></li>
<li><a href="https://cloud.google.com/pubsub/">Cloud Pub/Sub</a> attributes&nbsp;support</li>
<li>Named transformations for streaming&nbsp;update</li>
<li>Safe-guard against malformed tests and better error&nbsp;messages</li>
<li>Flexible custom <span class="caps">IO</span>&nbsp;wiring</li>
<li>KryoRegistrar for custom Kryo&nbsp;serialization</li>
<li>Table description for type-safe&nbsp;BigQuery</li>
<li>Lots of performance improvements and bug&nbsp;fixes</li>
</ul>
<p>I talked about …</p>
                    <a class="btn btn-default btn-xs" href="https://www.lyh.me/scio-at-philly-ete.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="https://www.lyh.me/joins.html">Joins</a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-03-28T14:38:00-04:00"> Tue 28 March 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://www.lyh.me/category/code.html">code</a>


<span class="label label-default">Tags</span>
	<a href="https://www.lyh.me/tag/scala.html">scala</a>
        /
	<a href="https://www.lyh.me/tag/fp.html">fp</a>
        /
	<a href="https://www.lyh.me/tag/data.html">data</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p>We recently started teaching <a href="https://github.com/spotify/scio">Scio</a> at Spotify&#8217;s internal data university and I made these <a href="/slides/joins.html">slides</a> to explain how joins work and some lower level&nbsp;details.</p>
<iframe src="/slides/joins.html" width="800" height="450"></iframe>
                    <a class="btn btn-default btn-xs" href="https://www.lyh.me/joins.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="https://www.lyh.me/for-comprehensions.html">For&nbsp;comprehensions</a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-03-28T12:23:00-04:00"> Tue 28 March 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="https://www.lyh.me/category/code.html">code</a>


<span class="label label-default">Tags</span>
	<a href="https://www.lyh.me/tag/scala.html">scala</a>
        /
	<a href="https://www.lyh.me/tag/fp.html">fp</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p>I made these <a href="/slides/for-yield.html">slides</a> on for comprehension a while ago but forgot to post them but here you&nbsp;go.</p>
<iframe src="/slides/for-yield.html" width="800" height="450"></iframe>
                    <a class="btn btn-default btn-xs" href="https://www.lyh.me/for-comprehensions.html">more ...</a>
                </div>
            </article>
            <hr/>

        <ul class="pagination">
                <li class="prev disabled"><a href="#">&laquo;</a></li>
                    <li class="active"><a
                            href="https://www.lyh.me/category/code.html">1</a></li>
                    <li class=""><a
                            href="https://www.lyh.me/category/code2.html">2</a></li>
                    <li class=""><a
                            href="https://www.lyh.me/category/code3.html">3</a></li>
                <li class="next"><a
                        href="https://www.lyh.me/category/code2.html">&raquo;</a></li>
        </ul>
        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="https://www.lyh.me//avatar.jpg"/>
        </p>
    <p>
      <strong>About Neville Li</strong><br/>
        
Data infrastructure @<a href="https://twitter.com/Spotify">Spotify</a>, ex-@<a href="https://twitter.com/Yahoo">Yahoo</a> search, das keyboard shredder, author of <a href="https://github.com/spotify/scio">Scio</a>

    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://open.spotify.com/user/sinisa_lyh"><i class="fa fa-spotify fa-lg"></i> Spotify</a></li>
    <li class="list-group-item"><a href="https://github.com/nevillelyh"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
    <li class="list-group-item"><a href="https://twitter.com/sinisa_lyh"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
    <li class="list-group-item"><a href="https://www.slideshare.net/sinisalyh"><i class="fa fa-slideshare fa-lg"></i> SlideShare</a></li>
    <li class="list-group-item"><a href="https://www.youtube.com/user/sinisalyh/videos"><i class="fa fa-youtube-square fa-lg"></i> YouTube</a></li>
    <li class="list-group-item"><a href="https://www.instagram.com/sinisa/"><i class="fa fa-instagram fa-lg"></i> Instagram</a></li>
    <li class="list-group-item"><a href="https://www.flickr.com/photos/sinisa_lyh"><i class="fa fa-flickr fa-lg"></i> Flickr</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="https://www.lyh.me/featran.html">Featran</a></li>
    <li class="list-group-item"><a href="https://www.lyh.me/automatic-type-class-derivation-with-shapeless.html">Automatic type-class derivation with&nbsp;Shapeless</a></li>
    <li class="list-group-item"><a href="https://www.lyh.me/lambda-serialization.html">Lambda&nbsp;serialization</a></li>
    <li class="list-group-item"><a href="https://www.lyh.me/lawfulness-of-aggregatebykey.html">Lawfulness of&nbsp;aggregateByKey</a></li>
    <li class="list-group-item"><a href="https://www.lyh.me/canbuildfrom.html">CanBuildFrom</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Categories -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4>
  <ul class="list-group" id="categories">
    <li class="list-group-item">
      <a href="https://www.lyh.me/category/code.html"><i class="fa fa-folder-open fa-lg"></i>code</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.lyh.me/category/misc.html"><i class="fa fa-folder-open fa-lg"></i>misc</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Categories -->

<!-- Sidebar/Twitter Timeline -->
<li class="list-group-item">
  <h4><i class="fa fa-twitter fa-lg"></i><span class="icon-label">Latest Tweets</span></h4>
  <div id="twitter_timeline">
    <a class="twitter-timeline" data-width="250" data-height="300" data-dnt="true" data-theme="light" href="https://twitter.com/sinisa_lyh">Tweets by sinisa_lyh</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</li>
<!-- End Sidebar/Twitter Timeline -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Neville Li
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">Creative Commons Attribution-NonCommercial 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://www.lyh.me/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://www.lyh.me/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://www.lyh.me/theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'lyh'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-6988688-5']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->


</body>
</html>